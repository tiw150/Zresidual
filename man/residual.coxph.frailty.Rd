% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/residual.coxph.R
\name{residual.coxph.frailty}
\alias{residual.coxph.frailty}
\title{Residuals for shared frailty Cox proportional hazards models}
\usage{
residual.coxph.frailty(
  fit_coxph,
  traindata,
  newdata,
  residual.type = c("censored Z-residual", "Cox-Snell", "martingale", "deviance")
)
}
\arguments{
\item{fit_coxph}{A fitted \code{\link[survival]{coxph}} object for a shared
frailty Cox model, typically specified with a term such as
\code{frailty(group)} in the model formula. The object must contain
cluster-level frailty estimates in \code{fit_coxph$frail}.}

\item{traindata}{A \code{data.frame} used to reconstruct the baseline
hazard and frailty effects. It must contain the survival response, all
fixed-effect covariates, and the shared frailty grouping factor appearing
in \code{fit_coxph$formula}.}

\item{newdata}{A \code{data.frame} for which residuals are to be computed.
It must contain the survival response, covariates, and the shared frailty
grouping factor used in the original model. The factor levels of the
grouping variable must be compatible with those in \code{traindata}.}

\item{residual.type}{Character string specifying the type of residual to
compute. Must be one of \code{"censored Z-residual"}, \code{"Cox-Snell"},
\code{"martingale"}, or \code{"deviance"}. The default is the full vector
\code{c("censored Z-residual", "Cox-Snell", "martingale", "deviance")},
but in typical use a single value should be supplied.}
}
\value{
A numeric matrix of dimension \eqn{n \times 1}, where \eqn{n} is
  the number of observations in \code{newdata}. The single column is named
  according to \code{residual.type}. Several attributes are attached:
  \itemize{
    \item \code{Survival.Prob}: vector of survival probabilities
      \eqn{S_{ij}(t_i)} for each observation in \code{newdata}.
    \item \code{linear.pred}: vector of fixed-effect linear predictors
      \eqn{\eta_{ij}} (excluding the frailty term).
    \item \code{covariates}: model matrix of fixed-effect covariates
      used in the linear predictor.
    \item \code{censored.status}: event indicator (1 = event, 0 = censored).
    \item \code{object.model.frame}: the \code{model.frame} constructed
      from \code{fit_coxph$formula} and \code{newdata}.
  }
}
\description{
Compute several types of residuals (censored Z-residuals, Cox–Snell,
martingale, and deviance) for shared frailty Cox proportional hazards
models fitted with \code{\link[survival]{coxph}} using a multiplicative
frailty term (e.g., \code{frailty(group)}).
}
\details{
The function is designed for an out-of-sample / cross-validation setting:
\itemize{
  \item \code{traindata} is used to reconstruct the baseline cumulative
        hazard and the relationship between covariates and shared frailty.
  \item \code{newdata} is the dataset for which residuals are computed.
}
Both datasets must contain the survival response, all fixed-effect
covariates, and the same frailty grouping factor (with compatible factor
levels). The grouping variable is extracted from the \code{frailty()}
term in \code{fit_coxph$formula} and must be a factor in both
\code{traindata} and \code{newdata}. The internal implementation treats
models with many groups (\code{gpnumber > 5}) and few groups
(\code{gpnumber <= 5}) slightly differently, reflecting how frailty
coefficients are stored in the fitted \code{coxph} object.
}
\examples{
\dontrun{
  library(survival)

  data(lung)
  lung$inst <- factor(lung$inst)

  ## Shared frailty Cox model
  set.seed(1)
  idx <- sample(seq_len(nrow(lung)), size = floor(0.7 * nrow(lung)))
  train_dat <- lung[idx, ]
  test_dat  <- lung[-idx, ]

  fit_frail <- coxph(Surv(time, status) ~ age + sex + frailty(inst),
                     data = train_dat)

  ## Censored Z-residuals on the test set
  r_z <- residual.coxph.frailty(fit_frail,
                                traindata = train_dat,
                                newdata   = test_dat,
                                residual.type = "censored Z-residual")

  ## Cox–Snell residuals
  r_cs <- residual.coxph.frailty(fit_frail,
                                 traindata = train_dat,
                                 newdata   = test_dat,
                                 residual.type = "Cox-Snell")
}
}
\keyword{internal}
