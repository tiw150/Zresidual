# Zresidual: Computing and Diagnosing Gaussian-like Residuals

![](reference/figures/logo.png)

## Z-residual

The **Zresidual** package implements diagnostic residuals based on the
**predictive distribution** of each observation. By utilizing the full
probabilistic information of the model, the package generates residuals
that are approximately normally distributed, enabling further standard
diagnostics for Pearson’s residuals for OLS.

The foundation of this approach is the **Randomized Survival Probability
(RSP)**. For a given observation y_i, the RSP represents the value of
the predictive cumulative distribution function (CDF) at y_i, with a
randomization term to ensure continuity for discrete outcomes. It is
defined as:

RSP_i(y_i \mid \theta) = S_i(y_i \mid \theta) + U_i \\ p_i(y_i \mid
\theta)

where S_i and p_i represent the survival function and probability mass
function, respectively, derived from the predictive distribution of y_i
given covariates \mathbf{x}\_i and parameters \theta. U_i \sim
\text{Unif}(0,1) is a random uniform variable used to handle discrete
outcomes. Under a correctly specified model where the observed data y_i
arises from the assumed predictive distribution, the RSP follows a
\text{Unif}(0,1) distribution.

The **Z-residual** is then derived by transforming the RSP via the
inverse standard normal cumulative distribution function:

z_i^{RSP}(y_i \mid \theta) = -\Phi^{-1}\[RSP_i(y_i \mid \theta)\]

Under correct model specification, these residuals follow a standard
normal N(0,1) distribution. This mapping allows researchers to assess
the quality of the predictive distribution—including its mean, variance,
and shape—using standard diagnostics for Gaussian OLS.

In practical applications, the parameter vector \theta must be
estimated. The package supports two primary paradigms for constructing
these residuals:

#### Frequentist Models

For frequentist models (e.g.,
[`survival::coxph`](https://rdrr.io/pkg/survival/man/coxph.html),
`glmmTMB`), the package computes residuals by plugging in the estimated
parameters \hat{\theta}. Furthermore, for `coxph` models, the package
provides cross-validatory Z-residuals to allow for more rigorous
validation of survival models within the frequentist framework.

#### Bayesian Models

For Bayesian models (e.g., `brms`), the package accounts for parameter
uncertainty by integrating over the posterior distribution:

- **Posterior Z-residuals:** These are obtained by averaging RSPs over
  the full-data posterior f(\theta \mid y). Although this approach
  involves “double use of data” since the same observations for both
  estimation and residual calculation, the z-residuals are
  asymptotically distributed as N(0,1) and the test p-values are
  asymptotically Uniform (0,1) as the approach of “summarize first then
  test” is used.

- **Importance-Sampling Cross-Validatory (ISCV) Z-residuals:** To
  provide a more robust diagnostic, the package implements ISCV
  Z-residuals. This method approximates leave-one-out (LOO) RSPs using
  importance sampling based on the full-data posterior. As for deleted
  residuals for OLS, ISCV Z-residuals have variance slightly greater
  than 1.

The resulting posterior and ISCV Z-residuals are approximately standard
normal, enabling a full range of graphical and numerical diagnostics for
Bayesian models.

## Supported Models

The **Zresidual** package provides built-in support for objects
generated by several prominent R modeling packages. The current
implementation includes:

- **`survival`**: Support for Cox Proportional Hazards models (`coxph`)
  and parametric survival models (`survreg`).
- **`glmmTMB`**: Support for Generalized Linear Mixed Models, including
  those with zero-inflation and complex covariance structures.
- **`brms`**: Support for a wide array of Bayesian regression models via
  the `brmsfit` interface.
- **`stats`**: Support for standard Generalized Linear Models (`glm`).
  (still incomplete)
- **Custom Models:** Support for any user-defined framework by providing
  log_cdf and log_pmf arguments to the generic `Zresidual` method.

## Installation

You can install the development version of this package from
[GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("tiw150/Zresidual")
```

## References

- Feng, C., Li, L., Sadeghpour, A., 2020. A comparison of residual
  diagnosis tools for diagnosing regression models for count data. BMC
  Medical Research Methodology 20, 175.
  <https://doi.org/10.1186/s12874-020-01055-2> (OA).

- Li L, Wu T, Feng C. Model diagnostics for censored regression via
  randomized survival probabilities. Statistics in Medicine. 2021; 40:
  1482–1497. <https://doi.org/10.1002/sim.8852>; [Reprint
  version](https://longhaisk.github.io/doc/1911.00198v4.pdf)

- Wu, T., Li, L., & Feng, C. (2024). Z-residual diagnostic tool for
  assessing covariate functional form in shared frailty models. Journal
  of Applied Statistics, 52(1), 28–58.
  <https://doi.org/10.1080/02664763.2024.2355551>; [Reprint
  version](https://longhaisk.github.io/doc/jas_z_residual_nolinear.pdf)

- Wu, T., Feng, C., & Li, L. (2024). Cross-Validatory Z-Residual for
  Diagnosing Shared Frailty Models. The American Statistician, 79(2),
  198–211. <https://doi.org/10.1080/00031305.2024.2421370>; [Reprint
  version](NA)

# Package index

## All functions

- [`CV.Zresidual()`](https://tiw150.github.io/Zresidual/reference/CV.Zresidual.md)
  : Cross-validated Z-residual diagnostics (generic)
- [`CV.Zresidual(`*`<coxph>`*`)`](https://tiw150.github.io/Zresidual/reference/CV.Zresidual.coxph.md)
  : Cross-validated Z-residuals for Cox proportional hazards models
- [`CV.Zresidual(`*`<survreg>`*`)`](https://tiw150.github.io/Zresidual/reference/CV.Zresidual.survreg.md)
  : Cross-validated Z-residuals for parametric survival regression
  models
- [`Zresidual()`](https://tiw150.github.io/Zresidual/reference/Zresidual.md)
  : Compute Z-residuals via an S3 generic
- [`Zresidual(`*`<bernoulli.brms>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.bernoulli.brms.md)
  : Z-residuals for Bernoulli models fitted with brms
- [`Zresidual(`*`<coxph.survival>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.coxph.survival.md)
  : Z-residuals for Cox proportional hazards models (survival package)
- [`Zresidual(`*`<hurdle_negbinomial.brms>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.hurdle_negbinomial.brms.md)
  : Z-residuals for hurdle negative binomial models fitted with brms
- [`Zresidual(`*`<hurdle_poisson.brms>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.hurdle_poisson.brms.md)
  : Z-residuals for hurdle Poisson models fitted with brms
- [`Zresidual(`*`<negbinomial.brms>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.negbinomial.brms.md)
  : Z-residuals for negative binomial models fitted with brms
- [`Zresidual(`*`<poisson.brms>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.poisson.brms.md)
  : Z-residuals for Poisson models fitted with brms
- [`Zresidual(`*`<survreg.survival>`*`)`](https://tiw150.github.io/Zresidual/reference/Zresidual.survreg.survival.md)
  : Z-residuals for parametric survival regression models (survival)
- [`aov.test.zresid()`](https://tiw150.github.io/Zresidual/reference/aov.test.zresid.md)
  : A function to calculate ANOVA of Zresidual
- [`bartlett.test(`*`<zresid>`*`)`](https://tiw150.github.io/Zresidual/reference/bartlett.test.zresid.md)
  : A function to calculate Bartlett of Zresidual
- [`boxplot(`*`<zresid>`*`)`](https://tiw150.github.io/Zresidual/reference/boxplot.zresid.md)
  : Boxplot of Z-Residuals
- [`cdf.tp()`](https://tiw150.github.io/Zresidual/reference/cdf.tp.md) :
  Cumulative Distribution Function (CDF) of Zero-Truncated Poisson
  Distribution
- [`dhurdle.nb()`](https://tiw150.github.io/Zresidual/reference/dhurdle.nb.md)
  : Probability Mass Function of the Hurdle Negative Binomial
  Distribution
- [`dhurdle.pois()`](https://tiw150.github.io/Zresidual/reference/dhurdle.pois.md)
  : Probability Mass Function of the Hurdle Poisson Distribution
- [`gof.censored.zresidual()`](https://tiw150.github.io/Zresidual/reference/gof.censored.zresidual.md)
  : Goodness-of-fit test for censored Z-residuals
- [`iscv_logrpp()`](https://tiw150.github.io/Zresidual/reference/iscv_logrpp.md)
  : Compute Log Randomized Predictive p-values using ISCV Method
- [`log_diff_exp()`](https://tiw150.github.io/Zresidual/reference/log_diff_exp.md)
  : A function to compute the logarithm of the difference between the
  exponentials of two log values.
- [`log_pred_dist_HNB()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_HNB.md)
  : Compute Log Predictive Distributions for a Hurdle Negative Binomial
  Model of a 'brms' Fit
- [`log_pred_dist_HP()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_HP.md)
  : Compute Log Predictive Distributions for a Hurdle Poisson Model of a
  'brms' Fit
- [`log_pred_dist_NB()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_NB.md)
  : Compute Log Predictive Distributions for a Negative Binomial Model
  of a 'brms' Fit
- [`log_pred_dist_TNB()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_TNB.md)
  : Compute Log Predictive Distributions for a Truncated Negative
  Binomial Model of a 'brms' Fit
- [`log_pred_dist_TP()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_TP.md)
  : Compute Log Predictive Distributions for a Truncated Poisson Model
  of a 'brms' Fit
- [`log_pred_dist_bern()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_bern.md)
  : Compute Log Predictive Distributions for Logistic Regression of a
  'brms' Fit
- [`log_pred_dist_pois()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_pois.md)
  : Compute Log Predictive Distributions for a Poisson Model of a 'brms'
  Fit
- [`log_pred_dist_zero()`](https://tiw150.github.io/Zresidual/reference/log_pred_dist_zero.md)
  : A function to calculate log predictive distribution (pmf and cdf) of
  logistic component of a 'brm' fit
- [`p_tnb()`](https://tiw150.github.io/Zresidual/reference/p_tnb.md) :
  Cumulative Distribution Function (CDF) of Zero-Truncated Negative
  Binomial Distribution
- [`pdf.tnb()`](https://tiw150.github.io/Zresidual/reference/pdf.tnb.md)
  : Probability Mass Function of the Zero-Truncated Negative Binomial
  Distribution
- [`pdf.tp()`](https://tiw150.github.io/Zresidual/reference/pdf.tp.md) :
  Probability Mass Function of the Zero-Truncated Poisson Distribution
- [`phurdle.nb()`](https://tiw150.github.io/Zresidual/reference/phurdle.nb.md)
  : Cumulative Distribution Function of the Hurdle Negative Binomial
  Distribution
- [`phurdle.pois()`](https://tiw150.github.io/Zresidual/reference/phurdle.pois.md)
  : Cumulative Distribution Function of the Hurdle Poisson Distribution
- [`plot(`*`<cs.residual>`*`)`](https://tiw150.github.io/Zresidual/reference/plot.cs.residual.md)
  : Cox–Snell residual plot for survival models
- [`plot(`*`<dev.resid>`*`)`](https://tiw150.github.io/Zresidual/reference/plot.dev.resid.md)
  : Plot deviance residuals for survival models
- [`plot(`*`<martg.resid>`*`)`](https://tiw150.github.io/Zresidual/reference/plot.martg.resid.md)
  : Plot martingale residuals for survival models
- [`plot(`*`<zresid>`*`)`](https://tiw150.github.io/Zresidual/reference/plot.zresid.md)
  : Plot Z-Residuals for Bayesian and Frequentist Count / Hurdle / Zero
  / Survival Models
- [`post_logmpp()`](https://tiw150.github.io/Zresidual/reference/post_logmpp.md)
  : Compute Posterior Log Middle-value Predictive p-values (Log-MPP)
- [`post_logrpp()`](https://tiw150.github.io/Zresidual/reference/post_logrpp.md)
  : Compute Posterior Log Randomized Predictive p-values (Log-RPP)
- [`posterior.pred()`](https://tiw150.github.io/Zresidual/reference/posterior.pred.md)
  : Extract Posterior Predicted Parameters from a Hurdle or Count Model
- [`pvalue.min()`](https://tiw150.github.io/Zresidual/reference/pvalue.min.md)
  : A function to calculate the min p-value
- [`qqnorm(`*`<zresid>`*`)`](https://tiw150.github.io/Zresidual/reference/qqnorm.zresid.md)
  : Normal Q-Q Plot for Z-Residuals with Outlier Detection and Normality
  Diagnostics
- [`sf.test.zresid()`](https://tiw150.github.io/Zresidual/reference/sf.test.zresid.md)
  : A function to calculate Shapiro-Francia test of Zresidual
- [`surv_residuals()`](https://tiw150.github.io/Zresidual/reference/surv_residuals.md)
  : Residuals for supported survival models
- [`sw.test.zresid()`](https://tiw150.github.io/Zresidual/reference/sw.test.zresid.md)
  : Shapiro-Wilk Normality Test for Z-Residuals
- [`test.var.bartl()`](https://tiw150.github.io/Zresidual/reference/test.var.bartl.md)
  : Bartlett Test for Homogeneity of Variances of Z-Residual

# Articles

### Illustration

- [An Animation for Understanding
  Z-residuals](https://tiw150.github.io/Zresidual/articles/illus_zresid.md):

### Demontration

- [Z-residual diagnostic tool for assessing covariate functional form in
  shared frailty
  models](https://tiw150.github.io/Zresidual/articles/demo_coxph_survival.md):
- [Demo of Cross-validatory Z-Residual for Diagnosing Shared Frailty
  Models](https://tiw150.github.io/Zresidual/articles/demo_cv_zresidual_survival.md):
- [Demo of Component-wise Z-residual Diagnosis for Bayesian Hurdle
  Models](https://tiw150.github.io/Zresidual/articles/demo_hurdle_brms.md):
- [Demo of Z-residual Diagnosis for Bayesian Logistic
  Regression](https://tiw150.github.io/Zresidual/articles/demo_logistic_brms.md):
